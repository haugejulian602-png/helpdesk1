{% extends "base.html" %}
{% block content %}

<h2>Sak #{{ ticket.id }} - {{ ticket.title }}</h2>

<p><b>Status:</b> {{ ticket.status }}</p>
<p><b>Prioritet:</b> {{ ticket.priority }}</p>
<p><b>Opprettet:</b> {{ ticket.created_at }}</p>

{% if ticket.assignee %}
<p><b>Ansvarlig:</b> {{ ticket.assignee }}</p>
{% else %}
<p><b>Ansvarlig:</b> (ikke satt)</p>
{% endif %}

<hr>

<h3>Beskrivelse</h3>
<p style="white-space:pre-wrap;">{{ ticket.description }}</p>

<hr>

{% if is_admin %}
  <h3>Oppdater status</h3>
  <form method="post" action="{{ url_for('main.set_status', ticket_id=ticket.id) }}">
    <select name="status">
      <option value="Åpen" {% if ticket.status == "Åpen" %}selected{% endif %}>Åpen</option>
      <option value="Pågår" {% if ticket.status == "Pågår" %}selected{% endif %}>Pågår</option>
      <option value="Lukket" {% if ticket.status == "Lukket" %}selected{% endif %}>Lukket</option>
    </select>
    <button type="submit">Lagre</button>
  </form>

  <hr>

  <h3>Sett ansvarlig</h3>
  <form method="post" action="{{ url_for('main.assign', ticket_id=ticket.id) }}">
    <input type="text" name="assignee" value="{{ ticket.assignee or '' }}" placeholder="Navn">
    <button type="submit">Lagre</button>
  </form>

  <hr>

  <h3>Kommentarer</h3>
  {% if ticket.comments and ticket.comments|length > 0 %}
    <ul>
      {% for c in ticket.comments %}
        <li><b>{{ c.name }}</b> ({{ c.time }}): {{ c.text }}</li>
      {% endfor %}
    </ul>
  {% else %}
    <p>Ingen kommentarer.</p>
  {% endif %}

  <h4>Legg til kommentar</h4>
  <form method="post" action="{{ url_for('main.add_comment', ticket_id=ticket.id) }}" style="max-width: 600px;">
    <input type="text" name="name" placeholder="Navn (valgfritt)" style="width: 220px;"><br><br>
    <textarea name="comment" rows="4" style="width:100%;" placeholder="Skriv kommentar..." required></textarea><br>
    <button type="submit">Legg til</button>
  </form>

  <hr>

  <form method="post" action="{{ url_for('main.delete_ticket', ticket_id=ticket.id) }}" onsubmit="return confirm('Slette saken permanent?');">
    <button type="submit">Slett sak (admin)</button>
  </form>

{% else %}
  <p><i>Du er ikke admin. Du kan se saken, men kan ikke endre status/ansvarlig/kommentar eller slette.</i></p>

  <h3>Kommentarer</h3>
  {% if ticket.comments and ticket.comments|length > 0 %}
    <ul>
      {% for c in ticket.comments %}
        <li><b>{{ c.name }}</b> ({{ c.time }}): {{ c.text }}</li>
      {% endfor %}
    </ul>
  {% else %}
    <p>Ingen kommentarer.</p>
  {% endif %}
{% endif %}

<p style="margin-top:14px;"><a href="{{ url_for('main.index') }}">Tilbake til oversikt</a></p>

{% endblock %}
